#!/bin/bash

vhroot='/var/www'
#mysql='/home/mysql/current/bin/mysql'
#mysqla='/home/mysql/current/bin/mysqladmin'

print_usage()
{
    if [ -n "$1" ]; then
        echo "    "
        echo "$1"
    fi
    echo "    "
    echo "USAGE $0 source_tree_root_dir site_name"
    echo "    "
    echo "    For example, to create a test site with a site_name of '${USER}test'"
    echo "    $0 $HOME/kevin/code/ ${USER}test"
    echo "    "
    exit 1
}
validate_source_directory()
{
    SOURCE=`readlink --canonicalize-existing $SOURCE`
echo $SOURCE
    if [ "`echo $SOURCE | cut -c1`" != / ]
    then
        print_usage "Error: Argument #1 must be an absolute path (not relative)."
    fi

    if [ ! -d "$SOURCE" -o ! -d "$SOURCE/application" ] ; then
        print_usage "It looks like the source directory you provided ($SOURCE) isn't a valid source directory."
    fi

}
validate_site_name()
{
    if [ -z "$SITE" -o "$SITE" = "trunk" -o ${SITE:0:4} = "rnw-" ] ; then
        print_usage "Your interface name ($SITE) looks bogus."
            fi
            if [ "`echo $SITE | grep _`" ] ; then
                print_usage "Your interface name must not contain an underscore ('_') because it will be used in the host name, where underscores are disallowed.";
    fi
        if [ "`echo $SITE | grep -P '[A-Z]'`" ] ; then
            print_usage "Your interface name must not contain uppercase letters because it will be used in the host name, where all values are lowercased by the browser.";
    fi
}
validate_files_exist()
{
    SOURCE=`readlink --canonicalize-existing $SOURCE`

    if [ ! -f "$SOURCE/bin/index.php" -o ! -f "$SOURCE/bin/.htaccess" ] ; then
        error_and_exit "Files that are needed don't exist bin/index.php or bin/.htaccess are not available.";
    fi
}
error_and_exit()
{
    echo "    "
    echo "ERROR:"
    echo "$1"
    echo "    "
    exit 1
}
create_vhost_entry()
{
    mkdir $vhroot/$SITE 
    chown -R $USER:$USER /var/www/$SITE
        if ! echo "
#vhost entry for $SITE cs dev site
<VirtualHost *:80>
        ServerName $SITE.sharpgroups.com
        DocumentRoot $vhroot/$SITE/
</VirtualHost>" > /etc/apache2/sites-available/$SITE.conf
        then
            error_and_exit "Error Vhost could not be added"
        fi
}
#set_site_url()
#{
#sed "s/sharpgroups.rightnow.com/$SITE.sharpgroups.rightnowtech.com" $SOURCE/application/config/config.php > $SOURCE/application/config/config.php
#}
SOURCE=$1
SITE=$2
if [ $# -ne 2 ]; then
    print_usage
fi

validate_source_directory
validate_site_name
validate_files_exist


create_vhost_entry
sudo a2ensite $SITE 

sudo service apache2 restart
cp $1/bin/index.php $vhroot/$2/.
#cp $1/bin/apitest.php $vhroot/$2/.
cp $1/bin/.htaccess $vhroot/$SITE/.
ln -s $1/application $vhroot/$SITE/application
ln -s $1/system $vhroot/$SITE/system
#ln -s $1/htdocs $vhroot/$2/htdocs

#$mysqla -f drop $2 2>&1 | egrep "Database.*dropped|doesn't exist" > /dev/null 2>&1  || error_and_exit "Failed database drop of $2"
#$mysqla create $2 > /dev/null;
#$mysql -e "GRANT ALL ON *.* TO '$USER'@'localhost';"
#curl http://$2.sharpgroups.rightnowtech.com/migrate

echo "    "
echo "New site was created and can be accessed from :"
echo "    "
echo "http://$2.sharpgroups.com/"
